# SAML

Security Assertion Markup Language (SAML) enables SSO(Single Sign On) for Service Provider(SP) by using Identity Provider(Identity Provider) to authenticate to multiple services using single credential.

This is a legacy protocol which utilizes XML in SAML requests & responses, improper utilization of XML itself will lead to lot of vulnerabilities like XXE, Hence usage of SAML is highly not recommended unless necessary. (Use OAUTH instead, which is easier to maintain & relatively safe)

#### Terms -&#x20;

1. User - User who want's to authenticate to a Client
2. Service Provider - Client which requires authentication (Ex: ManageEngine Endpoint Central Server)
3. Identity Provider - Server which authenticates user to access Service Providers (Ex:Okta)
4. SAML Request - Authentication request generated by SP & redirected to IdP
5. SAML Response - Authentication response generated by IdP & redirected to SP to login user based  on SAML Assertions present in SAML response.
6. SAML Assertion - SAML Assertion is a XML document present inside SAML response, these have information about user identity, authorization/roles, session expiry etc

#### Flow -&#x20;

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

1. User tries to access Service Provider
2. As, SP doesn't know user, so sends redirect to IdP with SAML Request in query params
3. Browser redirects to IdP with SAML Request in query params
4. IdP parses SAML Request, authenticates user.
5. IdP generates SAML Response
6. IdP redirects to SP with SAML response in query params
7. SP verifies SAML Response & signature, assertions & other user paroperties present in SAML Response
8. If SAML Response is valid & has valid signature, User is logged in mostly based on NameID parameter present in SAML assertion.

Note: To verify signature, SP must have public key of IdP stored locally either as certificate or metadata.



#### SAML Request

```markup
<?xml version="1.0"?>
 <samlp:AuthnRequest 
     xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol" 
     AssertionConsumerServiceURL="https://shibdemo-sp1.test.edu/Shibboleth.sso/SAML2/POST" 
     Destination="https://shibdemo-idp.test.edu/idp/profile/SAML2/Redirect/SSO" 
     ID="_cdae718238ba9c207a35cc7c70b046a0" 
     IssueInstant="2019-03-12T20:54:58Z" 
     ProtocolBinding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST" 
     Version="2.0">
    <saml:Issuer xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion">https://shibdemo-sp1.test.edu/shibboleth</saml:Issuer>
    <samlp:NameIDPolicy AllowCreate="1"/>
 </samlp:AuthnRequest>

```

**AssertionConsumerServiceURL** - Information to IdP regarding where SAML Response should be sent.

**Destination** - IdP's address where SAML Request is being sent to.

**ID** - To uniquely identify SAML Request, this should match with InResponseTo parameter in SAML Response in most of the cases.

**ProtocolBinding** - HTTP-Redirect or HTTP-POST are available options, where HTTP-Redirect is generally used.It specifies how should the SAML Response be sent to SP in a GET request or POST.



#### SAML Response

```xml
<?xml version="1.0" encoding="UTF-8"?>
 <samlp:Response Destination="https://shibdemo-sp1.test.edu/Shibboleth.sso/SAML2/POST" ID="_2af3ff4a06aa82058f0eaa8ae7866541" InResponseTo="_cdae718238ba9c207a35cc7c70b046a0" IssueInstant="2019-03-12T20:54:54.061Z" Version="2.0" xmlns:samlp="urn:oasis:names:tc:SAML:2.0:protocol">
     <saml:Issuer Format="urn:oasis:names:tc:SAML:2.0:nameid-format:entity" xmlns:saml="urn:oasis:names:tc:SAML:2.0:assertion">https://shibdemo-idp.test.edu/idp/shibboleth</saml:Issuer>  
     <ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
     <ds:SignedInfo>
       <ds:CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/>
       <ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"/>
       <ds:Reference URI="#_2af3ff4a06aa82058f0eaa8ae7866541">
         <ds:Transforms>
          <ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
           <ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/>
         </ds:Transforms>
         <ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/>
         <ds:DigestValue>Se+WwXd5r44J56LauTz/wnP3jWg=</ds:DigestValue>
       </ds:Reference>
     </ds:SignedInfo>
     <ds:SignatureValue>f8X28hHMpnTi/Hqi6phuxqbYKsf99Qi8QqVI3x3zRj6njs+J9ey7qxw4GTMV657IfmmMotE0IAIrmPh3lebX65bCUCpiDtFaP04KjWNGGWa7z6rjwhRIY6chYGYzdmrXWmvY2EXW3nkynAJ2vXo5mncOz2P17/bQgqDU6BTzfRzYU6q6TcGLjRd7pGMGbBm6wH5c8aHM4FaQZNv7qHkIVvTlCRcpg/b8qS2fWW8kwgklLXd1xTCXh9XedxrFWq75nSFZ6FiakfUMybC5YIqZ7nr4GfVKqdmh3wvCF/P9jrUkBNDsw3Id63UAwbnMVvBAYt2tgfiD5hpJ3ZLkzjds+g==</ds:SignatureValue>
     <ds:KeyInfo>
       <ds:X509Data>
         <ds:X509Certificate>MIIDXTCCAkWgAwIBAgIJAO7P8i9TJMuvMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwHhcNMTgwNDA1MDI1NTUyWhcNMjgwNDA0MDI1NTUyWjBFMQswCQYDVQQGEwJBVTETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UECgwYSW50ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwfSJJxxWvJ2Xok+Qx1OwQa+LA6mTSomOrgcJkRhfjeA9LMBmQlZKMdHiwKCaJBm7l1G13CNN2XhBZBqLFEX/4pPO5WBakAEa8h1i1ODmge1NKntcr3jPG8pGrzQVFbTpyoPaeJM5nSJUJhdI+QlXEYRZ2WUpKrrPXaG4O/bKFQ4FP7tRiYMi7SZde0QOUSTUlO14JA5L3jNUk0eha2hVULyCEa9WjbfOfw+0TvE32MrAhsu4QJQgr18q1x4+GNuOI0LkX1/WehXDstyjX68CxHRSNfsarX7HeOvqn8HbGkIAKMG1ldmSkyvJ0DrvEU+0wTxaTXxFR+zwFOBnSKIVBwIDAQABo1AwTjAdBgNVHQ4EFgQUn3h8qx+ssGm8balncHSF9hi01NQwHwYDVR0jBBgwFoAUn3h8qx+ssGm8balncHSF9hi01NQwDAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAuVmxbUhFA8cdnxgwHWYXniebXpPNMfoMBPpMao20uv9dkKHH2AzuT7TWAICiSj29ZuHEVJaK1mfwErr+R8etKnGT0tA53/509+gWG0eCQSh+AF/VPWQ4JRoPMszKdLzl4surnNOA5JegKVvTcT91+G+OWv0hB4iMD/quegLSBfrlbtyTT58Moj33wDDhaMH1Dlm23zfgB/0w3ztZnnmdxXJxGZuLiybJXTMbkjhUk41udHTQcsxKdaRoaQobDNdbqyl245RP15QXKphaz8DadCyH4v8o5NIU5lZyEG7KCpWnqWe6au6OrbGqBkqDIrEue3Wnu+TFaJRXBd12D9Xb8g==</ds:X509Certificate>
       </ds:X509Data>
     </ds:KeyInfo>
   </ds:Signature>
   <samlp:Status>
     <samlp:StatusCode Value="urn:oasis:names:tc:SAML:2.0:status:Success"/>
   </samlp:Status>
   <saml:Assertion xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ID="_e0acf8ced7e2cafc7c65b2c097842486e0838d76e0" IssueInstant="2019-03-13T22:44:33Z" Version="2.0">
     <saml:Issuer>https://shibdemo-idp.test.edu/idp/shibboleth</saml:Issuer>
     <ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
       <ds:SignedInfo>
         <ds:CanonicalizationMethod Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/>
         <ds:SignatureMethod Algorithm="http://www.w3.org/2000/09/xmldsig#rsa-sha1"/>
         <ds:Reference URI="#_e0acf8ced7e2cafc7c65b2c097842486e0838d76e0">
           <ds:Transforms>
             <ds:Transform Algorithm="http://www.w3.org/2000/09/xmldsig#enveloped-signature"/>
             <ds:Transform Algorithm="http://www.w3.org/2001/10/xml-exc-c14n#"/>
           </ds:Transforms>
           <ds:DigestMethod Algorithm="http://www.w3.org/2000/09/xmldsig#sha1"/>
           <ds:DigestValue>kDAb3x6EFvA9VblqwbIFcCnLQvo=</ds:DigestValue>
         </ds:Reference>
       </ds:SignedInfo>
       <ds:SignatureValue>e6qavbOCH8YAAMzDXnEwT4R7VBvan2gfYU6f5M1Akp6bqZqu3H4iJ5/VKtkMb7773E4RtDpY1vy9+6hLd/BQ2V5ZN6HG12JOVAgCr9rzna2sgNDYzGfmHsOwD9QJTOYZIFU3mtOSK6Lk8bZxM7wK5X0vmRNHI5a3oQlbWy9O6NtqZdm2AwI+zXb2ePV6lILjyoGkeuRId/35lA57OW+lBsGSz1T/X+5kVBdWRAYib2FAvGLIxInLt7jEDDfh93unL+YcbXevRcQLnKzrqTmu9TFIq+w0KeEnYxxPtCCmnnv86LWDhW30RJH2cS7kTsHa271RPsCCuutJD1QSaxVP1w==
       </ds:SignatureValue>
       <ds:KeyInfo>
         <ds:X509Data>
           <ds:X509Certificate>MIIDXTCCAkWgAwIBAgIJAO7P8i9TJMuvMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwHhcNMTgwNDA1MDI1NTUyWhcNMjgwNDA0MDI1NTUyWjBFMQswCQYDVQQGEwJBVTETMBEGA1UECAwKU29tZS1TdGF0ZTEhMB8GA1UECgwYSW50ZXJuZXQgV2lkZ2l0cyBQdHkgTHRkMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwfSJJxxWvJ2Xok+Qx1OwQa+LA6mTSomOrgcJkRhfjeA9LMBmQlZKMdHiwKCaJBm7l1G13CNN2XhBZBqLFEX/4pPO5WBakAEa8h1i1ODmge1NKntcr3jPG8pGrzQVFbTpyoPaeJM5nSJUJhdI+QlXEYRZ2WUpKrrPXaG4O/bKFQ4FP7tRiYMi7SZde0QOUSTUlO14JA5L3jNUk0eha2hVULyCEa9WjbfOfw+0TvE32MrAhsu4QJQgr18q1x4+GNuOI0LkX1/WehXDstyjX68CxHRSNfsarX7HeOvqn8HbGkIAKMG1ldmSkyvJ0DrvEU+0wTxaTXxFR+zwFOBnSKIVBwIDAQABo1AwTjAdBgNVHQ4EFgQUn3h8qx+ssGm8balncHSF9hi01NQwHwYDVR0jBBgwFoAUn3h8qx+ssGm8balncHSF9hi01NQwDAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAuVmxbUhFA8cdnxgwHWYXniebXpPNMfoMBPpMao20uv9dkKHH2AzuT7TWAICiSj29ZuHEVJaK1mfwErr+R8etKnGT0tA53/509+gWG0eCQSh+AF/VPWQ4JRoPMszKdLzl4surnNOA5JegKVvTcT91+G+OWv0hB4iMD/quegLSBfrlbtyTT58Moj33wDDhaMH1Dlm23zfgB/0w3ztZnnmdxXJxGZuLiybJXTMbkjhUk41udHTQcsxKdaRoaQobDNdbqyl245RP15QXKphaz8DadCyH4v8o5NIU5lZyEG7KCpWnqWe6au6OrbGqBkqDIrEue3Wnu+TFaJRXBd12D9Xb8g==</ds:X509Certificate>
         </ds:X509Data>
       </ds:KeyInfo>
     </ds:Signature>
     <saml:Subject>
       <saml:NameID Format="urn:oasis:names:tc:SAML:2.0:nameid-format:transient" SPNameQualifier="https://shibdemo-sp1.test.edu/shibboleth">epi</saml:NameID>
       <saml:SubjectConfirmation Method="urn:oasis:names:tc:SAML:2.0:cm:bearer">
         <saml:SubjectConfirmationData InResponseTo="_cdae718238ba9c207a35cc7c70b046a0" NotOnOrAfter="2019-03-13T22:49:33Z" Recipient="https://shibdemo-sp1.test.edu/Shibboleth.sso/SAML2/POST"/>
       </saml:SubjectConfirmation>
     </saml:Subject>
     <saml:Conditions NotBefore="2019-03-13T22:44:03Z" NotOnOrAfter="2019-03-13T22:49:33Z">
       <saml:AudienceRestriction>
         <saml:Audience>https://shibdemo-sp1.test.edu/shibboleth</saml:Audience>
       </saml:AudienceRestriction>
     </saml:Conditions>
     <saml:AuthnStatement AuthnInstant="2019-03-13T22:44:33Z" SessionIndex="_a52c3c1242663b44b706523f0a2ada454eb997e40a" SessionNotOnOrAfter="2019-03-14T06:44:33Z">
       <saml:AuthnContext>
         <saml:AuthnContextClassRef>urn:oasis:names:tc:SAML:2.0:ac:classes:Password</saml:AuthnContextClassRef>
       </saml:AuthnContext>
     </saml:AuthnStatement>
     <saml:AttributeStatement>
       <saml:Attribute Name="uid" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic">
         <saml:AttributeValue xsi:type="xs:string">epi</saml:AttributeValue>
       </saml:Attribute>
       <saml:Attribute Name="mail" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic">
         <saml:AttributeValue xsi:type="xs:string">epi@test.edu</saml:AttributeValue>
       </saml:Attribute>
       <saml:Attribute Name="first_name" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic">
         <saml:AttributeValue xsi:type="xs:string">epi</saml:AttributeValue>
       </saml:Attribute>
       <saml:Attribute Name="last_name" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:basic">
         <saml:AttributeValue xsi:type="xs:string">bar</saml:AttributeValue>
       </saml:Attribute>
     </saml:AttributeStatement>
   </saml:Assertion>
 </samlp:Response>
```

**ds:Signature -** [XML Signature](https://www.w3.org/TR/xmldsig-core1/#sec-Signature) that protects the integrity of SAML assertions & messages, the SAML assertion or may not be signed. The example above contains two ds:Signature elements. First ds:Signature element is signamture for whole SAML Response message, while later is that of SAML assertion.

**saml:Assertion** - These have information regarding user principal, user attributes, roles, session expiry & other user related information.

**saml:Subject** - It's contains the principal subject of SAML Assertion, the user or unique identifier which is used for authentication.The value of NameID is generally used as unique identifier for authentication.

**saml:StatusCode** - Denotes whether authentication is successfull in IdP or not.

**saml:Conditions** -  Specifies things like the time an Assertion is valid and that the Assertion is addressed to a particular Service Provider.

**saml:AuthnStatement** - Denotes that IdP authenticated the Subject of the Assertion.

**saml:AttributeStatement -** Has Attributes that describe the Subject of the Assertion.

#### XML Signature

```xml
<Signature>
  <SignedInfo>
    <CanonicalizationMethod />
    <SignatureMethod />
    <Reference>
       <Transforms />
       <DigestMethod />
       <DigestValue />
    </Reference>
    <Reference /> 
  </SignedInfo>
  <SignatureValue />
  <KeyInfo />
</Signature>
```

XML Signature can be used to sign entire SAML Response message or particular XML tree like assertion.

**Reference** element's URI attribute denotes element whose signature is calculated. This URI attribute must match ID attribute of element to be signed. For ex, URI="#\_e0acf8ced7e2cafc7c65b2c097842486e0838d76e0" in the SAML Response denotes it's signature for Assertion element with ID="\_e0acf8ced7e2cafc7c65b2c097842486e0838d76e0".

**CanonicalizationMethod** specifies whether the whitespaces or comments should be normalized or not.

**Transforms** specifies how the XML document must be transformed & how the signature must be calculated. Three common transforms are Enveloped Signature, Enveloping Signature & Detached Signature.

**Enveloped Signature** - In this type, Signature element is wrapped inside the element for which signature is being calculated.

```xml
<samlp:Response ... ID="..." ... >
    <ds:Signature>
    <ds:Reference URI="#...">
    </ds:Reference>
    </ds:Signature>
</samlp:Response>
```

**Enveloping Signature** - In this type, Element for which signature needs to be calculated is wrapped inside the Signature element.

```xml
<ds:Signature>
    <ds:Reference URI="#...">
    </ds:Reference>
    <samlp:Response ... ID="..." ... >
    </samlp:Response>
</ds:Signature>
```

**Detached Signature -** In this type, neither the signature element wraps the element it signs, nor the element which needs to be signed wraps the signature, i.e signature element is detached from the element which needs to be signed.

```xml
<samlp:Response ... ID="..." ... >
</samlp:Response>
<ds:Signature>
        <ds:Reference URI="#...">
        </ds:Reference>
</ds:Signature>
```

**DigestMethod** - This specifies the hashing algorithm which needs to be used to calculate digest value of element which needs to be signed.

**SignatureMethod** - Defines the signature algorithm which needs to be used to calculate Signature of reference element.

**KeyInfo** - This contains public key/certificate which needs to be used to check if signature is valid, It's the public key of IdP, It's suggested to store public key of IdP locally in SP & validate signature instead of relying on KeyInfo.

#### XSW Attacks -&#x20;

In XML Signature Wrapping(XSW) attack, attacker modifies the XML document such that signature of the reference element/document is still valid, but due to application logic error in retrieving the referenced element, application actually retrieves the maliciously induced reference element rather than the original one.

XSW 1 Example -&#x20;

<figure><img src="../../.gitbook/assets/xsw-1 (1).svg" alt=""><figcaption></figcaption></figure>

In the above example, the attacker tries to wrap original Response element inside another evil Response element, Keeping the signature references of the original Response element intact, so that signature doesn't change. Attacker also adds his own Assertion element inside his own evil Response element.

When application tries to check for signature it will appear to be valid, but when it retrieves assertion element it retrieves evil Response element's Assertion instead of the original Assertion element.

There are 8 such XSW types, these are better explained at [here](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/).

You can use [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burp Plugin to find all such XSW vulnerabilities easily.

#### Vulnerability Checklist

1. Check for XXE & XSLT related vulnerabilities
2. Check for DoS scenario by giving large amount of data in SAML Response for SP
3. Check for XSW attacks, [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) can be used to check for these attacks.
4. Check for Signature Exclusion attack, by removing the signature. [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) can be used to check for this attack.
5. Check for Invalid Signature attack, by modifying content of reference element. May be application is checking for presence of Signature element instead of validating it properly.
6. Check for Certificate Faking attack, If there is certificates present in SAML Response(KeyInfo) which is used for signature verification instead of locally stored IdP certificate, try to generate self signed certificate in KeyInfo & modify the contents of reference element & Sign the reference element using our own self signed certificate. You can use [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) to perform this attack.
7. Check for Token Recipient Confusion attack, Generate valid SAML Response for one SP, use the same SAML Response for some other SP.
8. Check for comment injection attack 1, for example if user able to register in IdP admin\<!--comment-->@idp.com, This will be parsed by SP as admin@idp.com depending upon canonicalization & logged in as admin@idp.com instead of admin\<!--comment-->@idp.com.
9. Check for replay attack after long time, to test is SP is properly validating saml:SubjectConfirmationData element's NotOnOrAfter attribute.
10. Check if SP is regularly validating if currently logged in user is present in IdP or not. After login to SP, delete account in IdP, even after long time if you are logged in to SP, it's a session management issue.\[[Mozilla's Blog](https://infosec.mozilla.org/guidelines/iam/saml.html#session-handling)]
